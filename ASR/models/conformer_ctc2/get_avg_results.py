import os
import codecs

import yaml
with open("conformer_ctc2/main_config.yaml", "r") as main_config_file:
    main_config = yaml.load(main_config_file, Loader=yaml.SafeLoader)
    config_filename = main_config['Current_experiment']['config_filename']

with open(f"conformer_ctc2/configs/{config_filename}","r") as config_file:
    config = yaml.load(config_file, Loader=yaml.SafeLoader)

output_filename = config['decode']['output_filename']

DECODE_SCRIPT_ERROR_RATE_OUTPUT_TEXTFILE = "wer-summary-test_cuts.txt" ## NB: "wer-summary-test_cuts.txt" is generated by the decode script by default. Don't change this. This textfile is read to obtain the error rate for a compilation file at the end of this script

for i in range(1,41): # Get WER for epochs 1 to 40

    cmd_string = f"python conformer_ctc2/decode_no_sil.py --epoch {str(i)}"
    print(cmd_string)
    
    #Store command
    out_handle = codecs.open(f"{config['train']['exp_dir']}/{output_filename}", "a", "utf-8")
    out_handle.write("\n\n")
    out_handle.write(cmd_string)
    out_handle.close()
    
    os.system(cmd_string)

    # #Store WER for plotting
    with open(f"{config['train']['exp_dir']}/{DECODE_SCRIPT_ERROR_RATE_OUTPUT_TEXTFILE}") as file:  
        contents = file.read().split('\n')
        WER = contents[1].split('\t')[1]

    out_handle = codecs.open(f"{config['train']['exp_dir']}/ssw_NCHLT_baseline_WER_compilation.txt", "a", "utf-8") 
    out_handle.write(f"Epoch_{i}\t{WER}\n")
    out_handle.close()