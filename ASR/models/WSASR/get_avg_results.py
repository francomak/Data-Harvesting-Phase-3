 
import os
import codecs

import yaml
with open("scripts/main_config.yaml", "r") as main_config_file:
    main_config = yaml.load(main_config_file, Loader=yaml.SafeLoader)
    config_filename = main_config['Current_experiment']['config_filename']

with open(f"scripts/configs/{config_filename}","r") as config_file:
    config = yaml.load(config_file, Loader=yaml.SafeLoader)

output_filename = config['decode']['output_filename']

DECODE_SCRIPT_ERROR_RATE_OUTPUT_TEXTFILE = "wer-summary-test_cuts.txt" ## NB: "wer-summary-test_cuts.txt" is generated by the decode script by default. Don't change this. This textfile is read to obtain the error rate for a compilation file at the end of this script

for i in range(20, 51):
    
    decode_args = [
        f"--epoch {str(i)}",
        f"--avg {config['decode']['average']}",
        f"--test_cuts_fname {config['datamodule']['test_cuts']}",  
        f"--use-averaged-model={config['decode']['use_averaged_model']}",
        f"--method {config['decode']['method']}",
        f"--exp-dir {config['train']['exp_dir']}",
        f"--lang-dir {config['datamodule']['lang_dir']}",
        f"--lm-dir {config['datamodule']['lm_dir']}",
        f"--manifest-dir {config['datamodule']['manifest_dir']}",
        f"--num-decoder-layers={config['decode']['num_decoder_layers']}"
    ]

    cmd_string = f"python scripts/decode_no_sil.py {' '.join(decode_args)}" # 2>> {config['train']['exp_dir']}/{output_filename}"
    print(cmd_string)
    
    #Store command
    out_handle = codecs.open(output_filename, "a", "utf-8")
    out_handle.write("\n\n")
    out_handle.write(cmd_string)
    out_handle.close()
    
    os.system(cmd_string)

    # #Store WER for plotting
    with open(f"{config['train']['exp_dir']}/{DECODE_SCRIPT_ERROR_RATE_OUTPUT_TEXTFILE}") as file:  
        contents = file.read().split('\n')
        WER = contents[1].split('\t')[1]

    out_handle = codecs.open(f"{config['train']['exp_dir']}/zul_only_second_testset_WER_compilation.txt", "a", "utf-8")  
    out_handle.write(f"Epoch_{i}\t{WER}\n")
    out_handle.close()